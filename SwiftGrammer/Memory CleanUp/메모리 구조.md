# 메모리 구조!
ARC를 배우기 전에 먼저 메모리 구조에 대해서 한번 배워보자!!
## 1. 메모리 구조
우리가 만약에 프로그램을 실행시키게 되면 프로그램을 위해서 OS가 메모리에 필요한 공간을 할당시켜 준다.

그 공간은 4가지로 나누어져 있는데
* Code (코드 영역)
* Data (데이터 영역)
* Heap (힙 영역)
* Stack (스택 영역)

위와 같다.
___
## 코드 영역
코드 영역 부분에는 우리가 작성한 소스 코드가 기계어 형태로 저장되게 된다.<br>
컴파일하는 타임에 결정이 되고, 중간에 코드가 변경되지 않게 하도록 **Read Only**형태로 저장되게 한다.

여기서 상식!
> 기계어 : 컴퓨터가 읽을 수 있는 가장 밑단의 언어.
>
> 예) 0,1
___
## 데이터 영역
데이터 영역 부분에는 전역변수와 static변수가 저장되게 된다.
프로그램의 시작과 동시에 할당이 되고, 프로그램을 종료 시켜야만 메모리를 해제 시킬 수 있다. <br>
실행 도중에 변수 값이 변경되면 안되니 Read-Write로 지정되게 한다.

### 예제
```swift 
struct Human {
    static let address = "Suncheon"
}

var name: String?
var age: Int?
```
여기서 name이랑 age부분은 전역 변수로 할당되고, <br>
address는 static변수로 할당된다.

보통 일반적인 프로그래밍에서는 static을 쓸 때 기본 동작이 lazy일터인데..

swift에서는 static 같은 경우 프로그램이 시작하는 동시에 할당되어 메모리가 올라가는게 아니라 해당 값에다가 처음으로 접근할 시에 값이 할당되어 메모리가 올라가서 그런 것 같다.
___
## 힙 영역
힙영역이란 프로그래머가 할당/해제하는 메모리 영역이다.

프로그래머는 힙영역을 malloc이랑 calloc으로 메모리를 할당 시킬 수 있으며, 이를 **동적 할당**이라고 한다.

동적 할당을 사용한 후에는 반드시 메모리 해제를 해주어야 한다.<br>
그렇지 않으면 memory leak이 발생하게 된다.

> memory leak : 메모리를 할당 해제할 수 없는 상태가 되는 것.

위에서 말했던 공간 4가지 중에 유일하게 런타임을 할 시에 결정되기 때문에 데이터의 크기가 확실하지 않을 때에 사용한다.

위의 정의를 봐보면 malloc이랑 calloc을 사용하여 힙에 메모리를 할당 시킨다고 했었는데, 스위프트에서는 동적 할당을 통해서 할당 시킬 일이 많이 없을 것이라고 생각했었을 수도 있다.

그러나!!!

우리는 swift에서 거의 항상 힙에 할당하고 있었다?!?

바로 클래스 인스턴스나 클로저 같은 참조 타입의 값들을 통해서 이것들 모두 자동으로 힙에 할당되게 된다!!

그리고 힙을 사용한 후에 반드시 메모리 해제를 시켜줘야 된다 했는데 우리가 클래스 인스턴스를 생성하고 메모리 해제를 시켜주는 작업을 한 적이 없었던 것 같은데, 도대체 메모리를 해제해주는 작업은 어떻게 해야되는 걸까라는 의심이 생길 수도 있다.

하지만!

swift에서는 ARC를 통하여 힙에 할당된 메모리가 더 이상 쓸모 없어지게 된다면 자동으로 해제해주기 때문에 그런 걱정은 갖다버리도록 하자.

### 힙의 장점
* 메모리 크기에 대한 제한이 없다.
* 본질적인 범위가 전역이기 때문에, 프로그램에 모든 함수에서 액세스가 가능하다!

### 힙의 단점
* 할당작업과 해제작업으로 인한 속도 저하 문제가 발생한다.
* 힙 손상 작업으로 인한 속도 저하 문제가 발생한다.
___
## 스택 영역
스택 영역은 함수 호출 시 함수의 지역변수, 매개변수, 리턴 값 등등이 저장이 되고, 함수가 종료된다면 저장된 메모리도 해제되게 된다.<br>
스택 영역은 컴파일 타임에 결정되기 때문에 무한히 할당은 불가능하다.

간단하게 말하자면 자동으로 사용하는 임시 메모리라고 생각해주면 될 것 같다.

```swift
func add(_ a: Int, _ b: Int) -> Int {
    let result = a + b
    return result
}
```
위에서 파라미터에 있는 a와 b는 스택에 할당되게 되고, 지역변수인 result도 스택에 할당되게 된다.

위 add함수를 호출하고 종료되는 시점에 스택에 저장된 메모리가 알아서 모두 반환되게 된다.

> 스택은 먼저 생성된 변수가 가장 나중에 해제되는 LIFO 데이터 구조이고 <br>
> CPU에 의해서 관리되고 최적화 돼서 속도가 매우 빠르다.

### 스택 장점
* CPU가 스택 메모리를 효율적으로 구성시키기 때문에 속도가 아주 빠르다.
* 메모리를 직접해제해주지 않아도 자동으로 알아서 해제된다.

### 스택 단점
* 메모리 크기에 대한 제한이 있다.
* 지역 변수만 액세스 가능하다.
___
## 힙과 스택의 관계
힙과 스택은 메모리 공간을 서로 공유한다.

같은 메모리 공간에서 힙은 낮은 메모리 주소로부터 할당을 받고, 스택은 높은 메모리 주소로부터 할당을 받는다.
